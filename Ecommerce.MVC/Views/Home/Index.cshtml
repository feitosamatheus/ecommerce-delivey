@model Ecommerce.MVC.Models.HomeViewModel
@using Ecommerce.MVC.Entities
@using Ecommerce.MVC.Enums
@using System.Globalization

@{
    ViewData["Title"] = "Início";
}

@functions {
    // Se você quiser limitar quantidade por slide do carrossel (mantendo 3 cards por slide)
    private static IEnumerable<List<T>> Chunk<T>(IEnumerable<T> source, int size)
    {
        var chunk = new List<T>(size);
        foreach (var item in source)
        {
            chunk.Add(item);
            if (chunk.Count == size)
            {
                yield return chunk;
                chunk = new List<T>(size);
            }
        }
        if (chunk.Count > 0) yield return chunk;
    }
}

<style>
    .bc-panel-none:empty {
        display: none;
    }
</style>

<div class="my-3 bc-container-home-desktop">
    <div class="row g-2">
        <div class="col-12 col-lg-8 col-xl-8">

            <!-- FILTRO -->
            <div class="bc-filter bc-filter--sticky p-3 box-shadown-custom mb-2">
                <div class="row g-3 align-items-center">
                    <div class="col-12 col-md px-2">
                        <div class="d-flex gap-3 align-items-center">

                            <!-- SELECT CATEGORIA -->
                            <div class="bc-select" data-name="filtroTipo" id="filtroCategoria">
                                <button type="button" class="bc-select__trigger">
                                    <span class="bc-select__value">Selecionar uma categoria</span>
                                    <span class="bc-select__arrow"></span>
                                </button>

                                <ul class="bc-select__options">
                                    <li data-value="">Todas</li>
                                    @foreach (var c in Model.Categorias.OrderBy(c => c.Nome))
                                    {
                                        <li data-value="@c.Id">@c.Nome</li>
                                    }
                                </ul>

                                <select name="filtroTipo" hidden>
                                    <option value="">Todas</option>
                                    @foreach (var c in Model.Categorias.OrderBy(c => c.Nome))
                                    {
                                        <option value="@c.Id">@c.Nome</option>
                                    }
                                </select>
                            </div>

                            <!-- INPUT BUSCA (inicialmente oculto) -->
                            <div class="position-relative d-none bc-filter__search" id="filtroTexto">
                                <i class="bi bi-search bc-filter__icon"></i>
                                <input type="text" id="filtroNome" class="form-control bc-filter__input" placeholder="Buscar por nome" />
                                <button type="button" class="bc-filter__close" id="btnFecharBusca" aria-label="Fechar busca">
                                    <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                                </button>
                            </div>

                            <!-- BOTÃO ABRIR BUSCA -->
                            <button class="btn bc-filter__btn" type="button" id="btnPesquisar" aria-label="Buscar" title="Buscar por nome">
                                <i class="fa-solid fa-keyboard"></i>
                            </button>

                        </div>
                    </div>
                </div>
            </div>


            @if (Model.Categorias.Count() <= 0)
            {
                <div class="bc-panel p-3 mb-3 text-center">
                    <div class="py-4 col-12">
                        <div class="fw-bold mb-1">Nenhum item disponível no momento</div>
                        <div class="text-muted">
                            Ainda não temos categorias com produtos para exibir. Volte em instantes ou tente novamente mais tarde.
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- CATEGORIAS TIPO CARROSSEL -->
                @foreach (var categoria in Model.Categorias.Where(c => c.TipoExibicao == ETipoExibicao.Carrossel))
                {
                    var carouselId = $"carrossel_{categoria.Id:N}";
                    var produtos = categoria.Produtos?.ToList() ?? new List<Produto>();
                    var slides = Chunk(produtos, 3).ToList(); // 3 itens por slide (como seu layout atual)

                    <div class="bc-panel p-3 mb-3" data-categoria-id="@categoria.Id">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h5 class="mb-0 fw-bold">@categoria.Nome</h5>
                        </div>

                        <div id="@carouselId" class="carousel slide mb-2" data-bs-ride="false">

                            <!-- INDICADORES -->
                            @if (slides.Count > 1)
                            {
                                <div class="carousel-indicators bc-carousel__indicators">
                                    @for (int i = 0; i < slides.Count; i++)
                                    {
                                        <button type="button"
                                                data-bs-target="#@carouselId"
                                                data-bs-slide-to="@i"
                                                class="@(i == 0 ? "active" : "")"
                                                aria-current="@(i == 0 ? "true" : "false")"
                                                aria-label="Slide @(i + 1)"></button>
                                    }
                                </div>
                            }

                            <div class="carousel-inner">
                                @for (int i = 0; i < slides.Count; i++)
                                {
                                    var slide = slides[i];
                                    <div class="carousel-item @(i == 0 ? "active" : "")">
                                        <div class="row g-3">
                                            @foreach (var p in slide)
                                            {
                                                <div class="col-12 col-md-4 bc-carousel-col">
                                                    <div class="bc-product bc-product--vertical bc-product-clickable bc-prod-col p-3" data-produto-id="@p.Id" data-categoria-id="@categoria.Id" data-nome="@p.Nome">
                                                        <div class="bc-product__thumb"
                                                            style="@(string.IsNullOrWhiteSpace(p.ImagemUrl) 
                                                                    ? "" 
                                                                    : $"background-image:url('{p.ImagemUrl}')")">
                                                        </div>

                                                        <div class="bc-product__info mt-3 text-center">
                                                            <div class="bc-product__title fw-bold">
                                                                @p.Nome
                                                            </div>

                                                            <div class="bc-product__price fw-bold mt-1">
                                                                @p.Preco.ToString("C", new CultureInfo("pt-BR"))
                                                            </div>
                                                        </div>
                                                        <!-- BOTÃO + -->
                                                        <button type="button" class="bc-product__add bc-product-clickable" aria-label="Adicionar ao carrinho" data-produto-id="@p.Id">
                                                            <i class="fa-solid fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- CONTROLES -->
                            @if (slides.Count > 1)
                            {
                                <button class="carousel-control-prev bc-carousel__btn"
                                        type="button"
                                        data-bs-target="#@carouselId"
                                        data-bs-slide="prev">
                                    <i class="fa-solid fa-chevron-left"></i>
                                </button>

                                <button class="carousel-control-next bc-carousel__btn"
                                        type="button"
                                        data-bs-target="#@carouselId"
                                        data-bs-slide="next">
                                    <i class="fa-solid fa-chevron-right"></i>
                                </button>
                            }
                        </div>
                    </div>
                }

                <!-- CATEGORIAS TIPO LISTA/BLOCO -->
                @foreach (var categoria in Model.Categorias.Where(c => c.TipoExibicao == ETipoExibicao.Bloco))
            {
                var produtos = categoria.Produtos?.ToList() ?? new List<Produto>();

                <div class="bc-panel p-3 mb-2" data-categoria-id="@categoria.Id">
                    <h5 class="mb-3 fw-bold">@categoria.Nome</h5>

                    <div class="row g-3 row-cols-1 row-cols-md-2">
                        @foreach (var p in produtos)
                        {
                            <div class="col bc-prod-col bc-product-clickable" data-produto-id="@p.Id" data-categoria-id="@categoria.Id" data-nome="@p.Nome">
                                <div class="bc-product p-3">
                                    <div class="d-flex gap-3">
                                        <div class="flex-grow-1 bc-product__info d-flex flex-column justify-content-between">
                                            <div>
                                                <div class="bc-product__title fw-bold text-dark mb-1" style="font-size: 1.05rem; line-height: 1.2;">
                                                    @p.Nome
                                                </div>

                                                @if (!string.IsNullOrWhiteSpace(p.Descricao))
                                                {
                                                    <div class="text-muted small lh-sm" style="font-size: 0.85rem; color: #6c757d !important;">
                                                        @(p.Descricao.Length > 60 ? p.Descricao.Substring(0, 60) + "..." : p.Descricao)
                                                    </div>
                                                }
                                            </div>

                                            <div class="mt-2 fw-bold bc-product__price" style="font-size: 1.1rem; color: #D98C1A;">
                                                @p.Preco.ToString("C", new CultureInfo("pt-BR"))
                                            </div>
                                        </div>

                                        <div class="bc-product__thumb"
                                                style="@(string.IsNullOrWhiteSpace(p.ImagemUrl) ? "" : $"background-image:url('{p.ImagemUrl}')")">
                                        </div>
                                    </div>
                                    <button type="button" class="bc-product__add bc-product-clickable" aria-label="Adicionar ao carrinho" data-produto-id="@p.Id">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                                <!-- BOTÃO + -->
                            </div>
                        }
                    </div>
                </div>
            }
            <div id="emptySearchStateDesktop" class="d-none flex-column align-items-center justify-content-center py-1 px-0 w-100">
                <div class="text-center p-5 bg-white shadow-sm" style="margin: 0 auto; border-radius:5px;">
                    <div class="mb-4 opacity-25">
                        <i class="fa-solid fa-magnifying-glass-chart fa-4x text-secondary"></i>
                    </div>
                    <h4 class="fw-bold" style="color: #3c1e0a;">Ops! Não encontramos nada</h4>
                    <p class="text-muted mb-4">
                        Não existem produtos que correspondam à sua busca ou filtro no momento. Tente usar termos diferentes ou limpar os filtros.
                    </p>
                    <button type="button" class="btn btn-outline-dark rounded-pill px-4 fw-bold" onclick="limparFiltroTexto('Mobile')">
                        <i class="fa-solid fa-rotate-left me-2"></i>Limpar Filtros
                    </button>
                </div>
            </div>
        }  
    </div>
    @await Component.InvokeAsync("Carrinho")
</div>
</div>

<div class="mb-2 mt-0 bc-container-home-mb p-2 p-lg-0 pt-0">
    <!-- FILTRO -->
    <div class="bc-filter bc-filter-mb bc-filter--sticky p-3 mb-2 box-shadown-custom" style="border-radius: 5px;">
        <div class="row g-3 align-items-center">
            <div class="col-12 px-1">
                <div class="d-flex gap-3 align-items-center">

                    <div class="bc-select w-100" data-name="filtroTipo" id="filtroCategoriaMobile">
                        <button type="button" class="bc-select__trigger">
                            <span class="bc-select__value">Selecionar uma categoria</span>
                            <span class="bc-select__arrow"></span>
                        </button>
                        <ul class="bc-select__options">
                            <li data-value="">Todas</li>
                            @foreach (var c in Model.Categorias.OrderBy(c => c.Nome))
                            {
                                <li data-value="@c.Id">@c.Nome</li>
                            }
                        </ul>
                    </div>

                    <div class="position-relative d-none bc-filter__search" id="filtroTextoMobile" style="width: 100%;">
                        <i class="bi bi-search bc-filter__icon"></i>
                        <input type="text" id="filtroNomeMobile" class="form-control bc-filter__input" placeholder="Buscar..." />
                        <button type="button" class="bc-filter__close" id="btnFecharBuscaMobile">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <button class="btn bc-filter__btn" type="button" id="btnPesquisarMobile" title="Buscar por texto">
                        <i class="fa-solid fa-keyboard"></i>
                    </button>

                </div>
            </div>
        </div>
    </div>

    @if (Model.Categorias.Count() <= 0)
    {
        <div class="bc-panel p-3 mb-3 text-center" style="border-radius: 5px;">
            <div class="py-4 col-12">
                <div class="fw-bold mb-1">Nenhum item disponível no momento</div>
                <div class="text-muted">
                    Ainda não temos categorias com produtos para exibir. Volte em instantes ou tente novamente mais tarde.
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- CATEGORIAS TIPO CARROSSEL -->
        @foreach (var categoria in Model.Categorias.Where(c => c.TipoExibicao == ETipoExibicao.Carrossel))
        {
            var carouselId = $"carrossel_{categoria.Id:N}";
            var produtos = categoria.Produtos?.ToList() ?? new List<Produto>();
            var slides = Chunk(produtos, 3).ToList(); // 3 itens por slide (como seu layout atual)

            <div class="bc-panel p-3 mb-3" data-categoria-id="@categoria.Id">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="mb-0 fw-bold">@categoria.Nome</h5>
                </div>

                <div id="@carouselId" class="carousel slide mb-2" data-bs-ride="false">

                    <!-- INDICADORES -->
                    @if (slides.Count > 1)
                    {
                        <div class="carousel-indicators bc-carousel__indicators">
                            @for (int i = 0; i < slides.Count; i++)
                            {
                                <button type="button"
                                        data-bs-target="#@carouselId"
                                        data-bs-slide-to="@i"
                                        class="@(i == 0 ? "active" : "")"
                                        aria-current="@(i == 0 ? "true" : "false")"
                                        aria-label="Slide @(i + 1)"></button>
                            }
                        </div>
                    }

                    <div class="carousel-inner">
                        @for (int i = 0; i < slides.Count; i++)
                        {
                            var slide = slides[i];
                            <div class="carousel-item @(i == 0 ? "active" : "")">
                                <div class="row g-3">
                                    @foreach (var p in slide)
                                    {
                                        <div class="col-12 col-md-4 bc-carousel-col">
                                            <div class="bc-product bc-product--vertical bc-prod-col p-3" data-produto-id="@p.Id" data-categoria-id="@categoria.Id" data-nome="@p.Nome">
                                                <div class="bc-product__thumb"
                                                    style="@(string.IsNullOrWhiteSpace(p.ImagemUrl) 
                                                            ? "" 
                                                            : $"background-image:url('{p.ImagemUrl}')")">
                                                </div>

                                                <div class="bc-product__info mt-3 text-center">
                                                    <div class="bc-product__title fw-bold">
                                                        @p.Nome
                                                    </div>

                                                    <div class="bc-product__price fw-bold mt-1">
                                                        @p.Preco.ToString("C", new CultureInfo("pt-BR"))
                                                    </div>
                                                </div>
                                                <!-- BOTÃO + -->
                                                <button type="button" class="bc-product__add bc-product-clickable" aria-label="Adicionar ao carrinho" data-produto-id="@p.Id">
                                                    <i class="fa-solid fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <!-- CONTROLES -->
                    @if (slides.Count > 1)
                    {
                        <button class="carousel-control-prev bc-carousel__btn"
                                type="button"
                                data-bs-target="#@carouselId"
                                data-bs-slide="prev">
                            <i class="fa-solid fa-chevron-left"></i>
                        </button>

                        <button class="carousel-control-next bc-carousel__btn"
                                type="button"
                                data-bs-target="#@carouselId"
                                data-bs-slide="next">
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    }
                </div>
            </div>
        }

        <!-- CATEGORIAS TIPO LISTA/BLOCO -->
        @foreach (var categoria in Model.Categorias.Where(c => c.TipoExibicao == ETipoExibicao.Bloco))
        {
            var produtos = categoria.Produtos?.ToList() ?? new List<Produto>();

        <div class="bc-panel p-3 mb-2" data-categoria-id="@categoria.Id" style="border-radius: 5px;">
                <h5 class="mb-3 fw-bold">@categoria.Nome</h5>

            <div class="row g-3 row-cols-1 row-cols-md-2">
                    @foreach (var p in produtos)
                    {
                    <div class="col bc-prod-col bc-product-clickable" data-produto-id="@p.Id" data-categoria-id="@categoria.Id" data-nome="@p.Nome">
                        <div class="bc-product p-3">
                                <div class="d-flex gap-3">
                                <div class="flex-grow-1 bc-product__info d-flex flex-column">
                                    <div class="mb-auto">
                                        <div class="fw-bold text-dark mb-1" style="font-size: 1.05rem; line-height: 1.2;">
                                            @p.Nome
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(p.Descricao))
                                        {
                                            <div class="text-muted small lh-sm" style="font-size: 0.85rem;">
                                                @(p.Descricao.Length > 60 ? p.Descricao.Substring(0, 60) + "..." : p.Descricao)
                                            </div>
                                        }
                                    </div>

                                    <div class="mt-2 fw-bold bc-product__price" style="font-size: 1.1rem; color: #D98C1A;">
                                        @p.Preco.ToString("C", new CultureInfo("pt-BR"))
                                    </div>
                                </div>

                                    <div class="bc-product__thumb"
                                            style="@(string.IsNullOrWhiteSpace(p.ImagemUrl) ? "" : $"background-image:url('{p.ImagemUrl}')")">
                                    </div>
                                </div>
                                <button type="button" class="bc-product__add bc-product-clickable" aria-label="Adicionar ao carrinho" data-produto-id="@p.Id">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                            <!-- BOTÃO + -->
                        </div>
                    }
                </div>
            </div>
        }

        <div id="emptySearchState" class="d-none flex-column align-items-center justify-content-center py-2 px-0 w-100">
            <div class="text-center p-5 bg-white shadow-sm" style="margin: 0 auto; border-radius:5px;">
                <div class="mb-4 opacity-25">
                    <i class="fa-solid fa-magnifying-glass-chart fa-4x text-secondary"></i>
                </div>
                <h4 class="fw-bold" style="color: #3c1e0a;">Ops! Não encontramos nada</h4>
                <p class="text-muted mb-4">
                    Não existem produtos que correspondam à sua busca ou filtro no momento. Tente usar termos diferentes ou limpar os filtros.
                </p>
                <button type="button" class="btn btn-outline-dark rounded-pill px-4 fw-bold" onclick="limparFiltroTexto('Mobile')">
                    <i class="fa-solid fa-rotate-left me-2"></i>Limpar Filtros
                </button>
            </div>
        </div>
    }  
</div>

<div id="modalHost"></div>
<script>
    

(function () {

        // =========================
      // Helpers
      // =========================
      const norm = (s) =>
        (s || "")
          .toString()
          .trim()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, ""); // remove acentos

      function getAllPanels() {
        return Array.from(document.querySelectorAll('.bc-panel[data-categoria-id]'));
      }

        function getAllProductCols(panelEl) {
          return Array.from(panelEl.querySelectorAll('.bc-prod-col[data-produto-id][data-nome]'));
        }

      function refreshCarousel(panelEl) {
        // Ajuste para carrosséis: esconde slides vazios
        const carousel = panelEl.querySelector(".carousel");
        if (!carousel) return;

        const slides = Array.from(carousel.querySelectorAll(".carousel-item"));
        slides.forEach((slide) => {
          const anyVisibleCard = slide.querySelector('.bc-product[data-produto-id][data-nome]:not(.d-none)');
          slide.classList.toggle("d-none", !anyVisibleCard);
        });

        // Se o slide ativo ficou oculto, move para o primeiro slide visível
        const active = carousel.querySelector(".carousel-item.active");
        if (active && active.classList.contains("d-none")) {
          active.classList.remove("active");
          const firstVisible = slides.find((s) => !s.classList.contains("d-none"));
          if (firstVisible) firstVisible.classList.add("active");
        }

        // Indicadores/controles: opcional esconder se só restou 1 slide visível
        const visibleSlides = slides.filter((s) => !s.classList.contains("d-none")).length;

        const indicators = carousel.querySelector(".carousel-indicators");
        const prevBtn = carousel.querySelector(".carousel-control-prev");
        const nextBtn = carousel.querySelector(".carousel-control-next");

        if (indicators) indicators.classList.toggle("d-none", visibleSlides <= 1);
        if (prevBtn) prevBtn.classList.toggle("d-none", visibleSlides <= 1);
        if (nextBtn) nextBtn.classList.toggle("d-none", visibleSlides <= 1);
      }

      // Estado único para desktop+mobile (mantém filtros sincronizados)
      const filterState = {
        categoriaId: "", // string
        texto: ""        // string normalizada
      };

          function applyFilters() {
      const categoriaId = (filterState.categoriaId || "").trim();
      const texto = norm(filterState.texto);
    const emptyState = document.getElementById('emptySearchState');
    const emptySearchStateDesktop = document.getElementById('emptySearchStateDesktop');

      const panels = getAllPanels();
    let totalPanelsVisible = 0;
      panels.forEach((panel) => {
        const panelCategoriaId = (panel.getAttribute("data-categoria-id") || "").trim();

        // 1) Categoria
        const categoriaOk = !categoriaId || panelCategoriaId === categoriaId;
        if (!categoriaOk) {
          panel.classList.add("d-none");
          return;
        }

        const cols = getAllProductCols(panel);

        // 2) Texto vazio: mostra tudo (COL e card interno)
        if (!texto) {
          cols.forEach((col) => {
            col.classList.remove("d-none");
            col.querySelector(".bc-product")?.classList.remove("d-none");
          });

          panel.classList.remove("d-none");
          refreshCarousel(panel);
          return;
        }

        // 3) Texto preenchido: filtra por data-nome da COLUNA
        let anyVisible = false;

        cols.forEach((col) => {
          const nome = norm(col.getAttribute("data-nome"));
          const match = nome.includes(texto);

          col.classList.toggle("d-none", !match);

          // opcional (não é necessário se a coluna já some, mas mantém coerência)
          col.querySelector(".bc-product")?.classList.toggle("d-none", !match);

          if (match) {
            anyVisible = true;
            totalPanelsVisible++;
            }
        });

        // 4) Painel: some se nada visível
        panel.classList.toggle("d-none", !anyVisible);

        refreshCarousel(panel);

        if (emptyState) {
            if (totalPanelsVisible === 0) {
                emptyState.classList.remove('d-none');
                emptyState.classList.add('d-flex');
            } else {
                emptyState.classList.add('d-none');
                emptyState.classList.remove('d-flex');
            }
        }

        if (emptySearchStateDesktop) {
            if (totalPanelsVisible === 0) {
                emptySearchStateDesktop.classList.remove('d-none');
                emptySearchStateDesktop.classList.add('d-flex');
            } else {
                emptySearchStateDesktop.classList.add('d-none');
                emptySearchStateDesktop.classList.remove('d-flex');
            }
        }
      });
    }


      // =========================
      // UI (Select custom + Busca)
      // =========================
      function setupFilterLogic(suffix = "") {
        const btnPesquisar = document.getElementById("btnPesquisar" + suffix);
        const btnFecharBusca = document.getElementById("btnFecharBusca" + suffix);
        const filtroCategoria = document.getElementById("filtroCategoria" + suffix);
        const filtroTexto = document.getElementById("filtroTexto" + suffix);
        const inputBusca = document.getElementById("filtroNome" + suffix);

        let modoBuscaTexto = false;

        function abrirBuscaTexto() {
          filtroCategoria?.classList.add("d-none");
          filtroTexto?.classList.remove("d-none");
          btnPesquisar?.classList.add("d-none");
          modoBuscaTexto = true;
          setTimeout(() => inputBusca?.focus(), 50);
        }

        function fecharBuscaTexto() {
          filtroTexto?.classList.add("d-none");
          filtroCategoria?.classList.remove("d-none");
          btnPesquisar?.classList.remove("d-none");
          modoBuscaTexto = false;

          if (inputBusca) {
            inputBusca.value = "";
            filterState.texto = "";
            const emptyState = document.getElementById('emptySearchState');
            emptyState?.classList.add('d-none');
            emptyState?.classList.remove('d-flex');

            const emptySearchStateDesktop = document.getElementById('emptySearchStateDesktop');
            emptySearchStateDesktop?.classList.add('d-none');
            emptySearchStateDesktop?.classList.remove('d-flex');
        
            applyFilters();
          }
        }

        btnPesquisar?.addEventListener("click", () => {
          if (!modoBuscaTexto) abrirBuscaTexto();
          else inputBusca?.focus();
        });

        btnFecharBusca?.addEventListener("click", fecharBuscaTexto);

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modoBuscaTexto) fecharBuscaTexto();
        });

        // ---- Select customizado (desktop e mobile) ----
        const selectWrap = document.getElementById("filtroCategoria" + suffix);
        if (selectWrap) {
          const trigger = selectWrap.querySelector(".bc-select__trigger");
          const optionsList = Array.from(selectWrap.querySelectorAll(".bc-select__options li"));
          const valueSpan = selectWrap.querySelector(".bc-select__value");
          const nativeSelect = selectWrap.querySelector("select"); // pode ser null no mobile

          trigger?.addEventListener("click", (e) => {
            e.stopPropagation();
            const isOpen = selectWrap.classList.contains("is-open");
            document.querySelectorAll(".bc-select").forEach((s) => s.classList.remove("is-open"));
            if (!isOpen) selectWrap.classList.add("is-open");
          });

          optionsList.forEach((option) => {
            option.addEventListener("click", (e) => {
              e.stopPropagation();

              optionsList.forEach((o) => o.classList.remove("is-selected"));
              option.classList.add("is-selected");

              if (valueSpan) valueSpan.textContent = option.textContent;

              const categoriaId = option.dataset.value || "";

              // Atualiza nativo (se existir) só para manter consistência
              if (nativeSelect) {
                nativeSelect.value = categoriaId;
              }

              // Atualiza estado global e aplica filtro
              filterState.categoriaId = categoriaId;
              applyFilters();

              selectWrap.classList.remove("is-open");
            });
          });
        }

        // ---- Texto ----
        inputBusca?.addEventListener("input", () => {
          filterState.texto = inputBusca.value || "";
          applyFilters();
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        setupFilterLogic("");
        setupFilterLogic("Mobile");

        document.addEventListener("click", () => {
          document.querySelectorAll(".bc-select").forEach((s) => s.classList.remove("is-open"));
        });

        // aplica estado inicial (caso queira iniciar com tudo visível)
        applyFilters();
      });

    const host = document.getElementById('modalHost');

    async function abrirModalProduto(produtoId) {

        if (!host) return;

        // Remove modal anterior
        const old = document.getElementById('modalAddProduto');
        if (old) old.remove();

        try {
            addLoading("Carregando...");

            const resp = await fetch(`/Produto/BuscarModalAdicionarProduto?id=${encodeURIComponent(produtoId)}`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });

            if (!resp.ok) {
            throw new Error(`Erro HTTP ${resp.status}`);
            }

            const html = await resp.text();
            host.insertAdjacentHTML('beforeend', html);

            const modalEl = document.getElementById('modalAddProduto');
            if (!modalEl) return;

            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

            modalEl.addEventListener('hidden.bs.modal', () => {
            modalEl.remove();
            }, { once: true });

            modal.show();


        } catch (err) {
            console.error('Erro ao carregar modal:', err);
            alert('Não foi possível carregar o produto. Tente novamente.');
            removeLoading();
        } finally {
            removeLoading();
        }
    }

    document.addEventListener('click', (e) => {
        const el = e.target.closest('.bc-product-clickable');
        if (!el) return;

        console.log('CLICK:', el, 'produtoId:', el.dataset.produtoId);

        const produtoId = el.dataset.produtoId;
        if (!produtoId) return;

        abrirModalProduto(produtoId);
    });

    window.limparFiltroTexto = function (suffix = "") {
        const inputBusca = document.getElementById("filtroNome");
        const inputBuscaMobile = document.getElementById("filtroNomeMobile");

        if (inputBusca) inputBusca.value = "";
        if (inputBuscaMobile) inputBuscaMobile.value = "";

        filterState.texto = "";
        
        // Dentro da sua applyFilters...
        const emptyState = document.getElementById('emptySearchState');
        emptyState?.classList.add('d-none');
        emptyState?.classList.remove('d-flex');

        // Dentro da sua applyFilters...
        const emptySearchStateDesktop = document.getElementById('emptySearchStateDesktop');
        emptySearchStateDesktop?.classList.add('d-none');
        emptySearchStateDesktop?.classList.remove('d-flex');

        // Agora ele ENXERGA a applyFilters porque estão no mesmo escopo
        applyFilters(); 
    };
})();

</script>




