<div class="modal fade" id="modalFinalizarPedido" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; background: #fcfcfc;">

      <div class="modal-header border-0 pb-0">
        @* <button type="button" class="btn btn-link text-dark p-0" id="btnWizardBack">
          <i class="bi bi-arrow-left fs-4"></i>
        </button> *@
                <div style="position: absolute; right: 15px; top: 10px; z-index: 10;">
                    <button type="button" class="btn-close-custom" data-bs-dismiss="modal" aria-label="Fechar">√ó</button>
                </div>

            <div style="width: 24px;"></div>
      </div>

            <div class="modal-body" id="modalFinalizarPedidoBody" style="transform: scale(0.9);"></div>

            <div class="modal-footer border-0 p-4 pt-0 d-flex gap-2" style="transform: scale(0.9); margin-top: -44px;">
        <button type="button" class="btn btn-light w-25 fw-bold py-3"
                        id="btnWizardPrev" style="background: #e9ecef;     border-radius: 32px !important;">
          Voltar
        </button>

                <button type="button" class="btn w-50 fw-bold py-3 text-white btn-proximo"
                        id="btnWizardNext" style="background:#3c1e0a;     border-radius: 32px !important;">
          Avan√ßar
        </button>
      </div>

    </div>
  </div>
</div>

<script>
    // -----------------------------
    // Util: Atualiza resumo Step 2
    // -----------------------------
    function atualizarResumo() {
      const diaTexto = $('input[name="diaSelecionado"]:checked')
        .next('label')
        .text()
        .replace(/\s+/g, ' ')
        .trim();

      const horaTexto = $('input[name="horarioFinal"]:checked').next('label').text().trim();
      const obs = ($('#obsPedido').val() || '').trim() || 'Nenhuma observa√ß√£o';

      $('#resumoDataHora').text(horaTexto ? `${diaTexto} √†s ${horaTexto}` : 'Hor√°rio n√£o selecionado');
      $('#resumoObs').text(obs);
    }

    // -----------------------------
    // Wizard (somente navega√ß√£o)
    // -----------------------------
    (() => {
      const MODAL_ID = 'modalFinalizarPedido';
      const titles = { 1: 'Recebimento do Pedido', 2: 'Confirma√ß√£o do pedido', 3: 'Pagamento' };
      let step = 1;

      function root() { return document.getElementById(MODAL_ID); }
      function qs(sel) { return root()?.querySelector(sel); }
      function qsa(sel) { return root()?.querySelectorAll(sel) ?? []; }

      // Caso voc√™ ainda precise ler step fora (opcional)
      window.getWizardStepFinalizarPedido = () => step;

      function updateWizardProgress(currentStep) {
        qsa('.wizard-step-indicator').forEach(indicator => {
          const s = Number(indicator.dataset.step);
          indicator.classList.remove('active', 'completed');
          if (s < currentStep) indicator.classList.add('completed');
          if (s === currentStep) indicator.classList.add('active');
        });
      }

      function setTitle(currentStep) {
        const titleEl = qs('#wizardTitle');
        if (titleEl) titleEl.textContent = titles[currentStep] || '';
      }

      function canGoNextStep1() {
        const metodo = qs('input[name="metodoEntrega"]:checked');
        if (!metodo) return false;

        const horario = (qs('#inputHorarioFinal')?.value || '').trim();
        return !!horario;
      }

      function setButtons(currentStep) {
        const prevBtn = qs('#btnWizardPrev');
        const nextBtn = qs('#btnWizardNext');

        if (prevBtn) prevBtn.disabled = (currentStep === 1);
        if (!nextBtn) return;

        // üî• Regra principal: s√≥ no Step 2 o bot√£o tem data-action="confirmar"
        nextBtn.removeAttribute('data-action');

        if (currentStep === 1) {
          nextBtn.textContent = 'Avan√ßar';
          nextBtn.disabled = !canGoNextStep1();
          return;
        }

        if (currentStep === 2) {
          nextBtn.textContent = 'Confirmar pedido';
          nextBtn.disabled = false;

          // ‚úÖ marcador para o handler do AJAX
          nextBtn.setAttribute('data-action', 'confirmar');
          return;
        }

        if (currentStep === 3) {
          nextBtn.textContent = 'Fechar';
          nextBtn.disabled = false;
        }
      }

      function showStep(nextStep) {
        step = nextStep;

        if (!qsa('.wizard-step').length) return;

        qsa('.wizard-step').forEach(s => s.classList.add('d-none'));
        const current = qs(`.wizard-step[data-step="${step}"]`);
        if (current) current.classList.remove('d-none');

        setTitle(step);
        setButtons(step);
        updateWizardProgress(step);
      }

      function validarStep1() {
        if (!canGoNextStep1()) {
          alert('Selecione um dia e um hor√°rio para retirada.');
          return false;
        }
        return true;
      }

      // -----------------------------
      // Navega√ß√£o do wizard (SEM AJAX)
      // -----------------------------
      document.addEventListener('click', (e) => {
        if (!root()) return;

        // Voltar
        if (e.target.closest(`#${MODAL_ID} #btnWizardPrev`)) {
          if (step > 1) showStep(step - 1);
          return;
        }

        // Bot√£o principal
        if (e.target.closest(`#${MODAL_ID} #btnWizardNext`)) {

          // Step 1 -> Step 2
          if (step === 1) {
            if (!validarStep1()) return;
            atualizarResumo();
            showStep(2);
            return;
          }

          // Step 2 -> N√ÉO FAZ NADA AQUI
          // porque o handler do AJAX (abaixo) vai capturar
          if (step === 2) {
            return;
          }

          // Step 3 -> Fechar modal
          if (step === 3) {
            const modal = bootstrap.Modal.getInstance(document.getElementById(MODAL_ID));
            modal?.hide();
            return;
          }
        }
      });

      // Habilita/desabilita bot√£o no Step 1 conforme sele√ß√£o
      document.addEventListener('change', (e) => {
        if (!root()) return;

        if (e.target.matches('.btn-check-dia')) {
          setButtons(1);
          return;
        }

        if (e.target.matches('input[name="horarioFinal"]')) {
          const hidden = qs('#inputHorarioFinal');
          if (hidden) hidden.value = e.target.value;
          setButtons(1);
          return;
        }

        if (e.target.matches('input[name="metodoEntrega"]')) {
          setButtons(1);
          return;
        }
      });

      // Modal open
      document.addEventListener('shown.bs.modal', (e) => {
        if (e.target?.id === MODAL_ID) showStep(1);
      });

      // Se injetar via AJAX
      window.wizardInitFinalizarPedido = function () {
        step = 1;
        showStep(1);
      };

      // Exp√µe showStep para o handler do AJAX usar no success
      window._wizardShowStepFinalizarPedido = showStep;
    })();

    // -----------------------------
    // Step 2: Confirmar pedido (AJAX) ‚Äì SOMENTE quando data-action="confirmar"
    // -----------------------------
    $(document).on('click', '#btnWizardNext[data-action="confirmar"]', function (e) {
      e.preventDefault();
      e.stopImmediatePropagation(); // ‚úÖ impede que o wizard trate esse clique tamb√©m

      addLoading("Confirmando...");

      const horario = ($('#inputHorarioFinal').val() || '').trim();
      const observacao = ($('#obsPedido').val() || '').trim();

      if (!horario) {
        alert('Por favor, selecione um hor√°rio para retirada.');
        return;
      }

      const payload = {
        horarioRetirada: horario,
        observacao: observacao
      };

      const $btn = $(this);
      $btn.prop('disabled', true)
        .html('<span class="spinner-border spinner-border-sm"></span> Processando...');

      $.ajax({
        url: '/Pedido/Confirmar',
        method: 'POST',
        contentType: 'application/json; charset=utf-8',
        data: JSON.stringify(payload),
        success: function (res) {
          // ‚úÖ aqui voc√™ preenche o Step 3 com o retorno (QR code / copia e cola / expira√ß√£o etc.)
          // Exemplo:
          // $('#pixQrImg').attr('src', 'data:image/png;base64,' + res.qrCodeBase64);
          // $('#pixCopiaCola').val(res.pixCopiaCola);

          // Vai pro Step 3
          if (typeof window._wizardShowStepFinalizarPedido === 'function') {
            window._wizardShowStepFinalizarPedido(3);
          }

          // O setButtons(3) j√° coloca "Fechar"
          $btn.prop('disabled', false).text('Fechar');
          removeLoading();
        },
        error: function (xhr) {
          $btn.prop('disabled', false).text('Confirmar pedido');
          alert(xhr.responseText || 'Erro ao processar pedido.');
          removeLoading();
        }
      });
    });
</script>



