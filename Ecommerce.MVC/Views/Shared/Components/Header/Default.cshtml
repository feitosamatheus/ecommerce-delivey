<section class="bc-hero">
    <div class="bc-hero__banner"></div>
    <header class="p-3 mx-2 mx-md-3 box-shadown-custom bc-hero__header">
        <div class="row">
            <div class="col-12 col-lg-10 d-flex flex-column flex-md-row align-items-center gap-0 gap-md-3">
                <div class="w-100 d-flex justify-content-end position-absolute" style="top:35px; margin-right: 60px;">
                    <a href="/login" class="btn btn-login-icon d-flex d-md-none gap-2 text-dark">
                        <i class="fa-solid fa-bars"></i>
                    </a>
                </div>

                <div class="text-center text-md-start">
                    <img class="bc-hero__logo mb-2 mb-md-0" src="~/img/logo.jpg" alt="Logo Barriga Cheia" />
                </div>

                <div class="text-center text-md-start">
                    <h1 class="bc-hero__title mb-1">Barriga Cheia</h1>
                    <p class="bc-hero__subtitle mb-0" style="color: #e0c9a6;"><span>Sopas & Caldos</span> · <span>Lanchonete</span></p>
                    <small class="bc-hero__meta" style="color: #e0c9a6;">
                        Olinda-PE · Rua Nilson Sabino Pinho, 222
                    </small>

                    <div class="d-flex gap-3 mt-2 justify-content-center justify-content-md-start d-none d-md-flex">
                        <a href="#" class="bc-social__btn is-phone"><i class="fa-solid fa-phone"></i></a>
                        <a href="#" class="bc-social__btn is-instagram"><i class="fa-brands fa-instagram"></i></a>
                        <a href="#" class="bc-social__btn is-facebook"><i class="fa-brands fa-facebook-f"></i></a>
                        <a href="#" class="bc-social__btn is-whatsapp"><i class="fa-brands fa-whatsapp"></i></a>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-2 d-flex justify-content-end align-items-end mt-3 mt-md-0 gap-3">
                <button type="button" class="btn bc-nav-btn shadow-sm position-relative @(ViewBag.Autenticado ? "btn-acompanhar-pedido" : "btn-acompanhar-pedido-login")">
                    <i class="fas fa-receipt me-2"></i>
                    <span>
                        Meus Pedidos
                        @if (ViewBag.Autenticado && ViewBag.TotalPedidos > 0)
                        {
                            <span class="badge rounded-pill shadow bg-danger position-absolute"
                                  style="font-size: 0.7rem; top: -5px; right: -5px;">
                                @ViewBag.TotalPedidos
                                <span class="visually-hidden">Meus Pedidos</span>
                            </span>
                        }
                    </span>
                </button>

                <button type="button" class="btn bc-nav-btn shadow-sm" data-bs-toggle="modal" data-bs-target="#modalVerMais">
                    <span style="position: relative; top: -1px;">Ver mais</span>
                </button>
               
                @if (ViewBag.Autenticado)
                {
                    <div class="dropdown d-none d-md-inline-block">
                        <button type="button"
                                class="btn btn-light d-flex align-items-center fw-bold shadow-sm btn-lift"
                                id="btn-conta-dropdown"
                                data-bs-toggle="dropdown" 
                                aria-expanded="false"
                                title="Minha conta"
                                style="color: #4b2c20; border-radius: 50px; padding: 6px 18px; border: 1px solid #eee;">

                            <i class="fa-solid fa-circle-user fs-5 me-2" style="color: #4a2a15;"></i>
                            
                            <span class="text-truncate" style="max-width: 110px; font-size: 0.9rem;">
                                @ViewBag.NomeCliente.Split(' ')[0]
                            </span>

                            <i class="fa-solid fa-chevron-down ms-2 seta-menu" style="font-size: 0.7rem; opacity: 0.6;"></i> 
                        </button>

                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-2 mt-2" 
                            style="border-radius: 15px; min-width: 250px; background-color: #ffffff; bottom: 115% !important; top: auto !important; margin-top: 8px;z-index: 99999;">
                            
                            <li class="px-3 py-3">
                                <div class="d-flex flex-column">
                                    <span class="fw-bold" style="font-size: 0.95rem; color: #4b2c20;">Olá, @ViewBag.NomeCliente.Split(' ')[0]!</span>
                                    <small class="text-muted" style="font-size: 0.75rem;">O que deseja fazer agora?</small>
                                </div>
                            </li>

                            <li><hr class="dropdown-divider my-2 opacity-50"></li>

                            @* <li>
                                <button class="dropdown-item py-2 d-flex align-items-center rounded-3" type="button" id="btn-meus-pedidos">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                                        <i class="fa-solid fa-basket-shopping text-secondary" style="font-size: 0.85rem;"></i>
                                    </div>
                                    <span class="fw-semibold">Meus Pedidos</span>
                                </button>
                            </li> *@

                            <li>
                                <button class="dropdown-item btn-acompanhar-pedido py-2 d-flex align-items-center rounded-3 btn-acompanhar-pedido-nav btn-hover-sidebar" type="button">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                                        <i class="fas fa-receipt text-secondary" style="font-size: 0.85rem;"></i>
                                    </div>
                                    <span class="fw-semibold">Meus Pedidos</span>
                                </button>
                            </li>

                            <li>
                                <button class="dropdown-item py-2 d-flex align-items-center rounded-3 btn-hover-sidebar" type="button" data-bs-toggle="modal" data-bs-target="#modalAlterarSenhaCliente">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                                        <i class="fa-solid fa-lock text-secondary" style="font-size: 0.85rem;"></i>
                                    </div>
                                    <span class="fw-semibold">Alterar Senha</span>
                                </button>
                            </li>

                            <li><hr class="dropdown-divider my-2 opacity-50"></li>

                            <li>
                                <button class="dropdown-item py-2 d-flex align-items-center rounded-3 text-danger" type="button" id="btn-sair">
                                    <div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                                        <i class="fa-solid fa-right-from-bracket" style="font-size: 0.85rem;"></i>
                                    </div>
                                    <span class="fw-semibold">Sair da conta</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                }
                else
                {
                    <button type="button"
                            class="btn btn-light d-none d-md-flex align-items-center fw-bold shadow-sm btn-lift"
                            id="btn-abrir-login"
                            style="color: #4b2c20; border-radius: 50px; padding: 6px 18px; white-space: nowrap; font-size: 0.9rem;"
                            title="Entrar">

                        <i class="fa-solid fa-circle-user fs-5 me-2" style="color: #4a2a15;"></i>
                        <span class="text-truncate" style="max-width: 100px;">Entrar</span>
                    </button>
                }
            </div>
        </div>
    </header>
</section>

<section class="bc-mb-hero p-2">
    <div class="bc-mb-hero__banner"></div>
    <header class="bc-mb-header">
        <div class="container-fluid px-3">
            <div class="d-flex align-items-center gap-3"> 
                <div class="bc-mb-logo-wrapper">
                    <img class="bc-mb-logo" src="~/img/logo.jpg" alt="Logo Barriga Cheia" />
                </div>

                <div class="bc-mb-info-group">
                    <div class="d-flex align-items-baseline flex-wrap gap-2">
                        <h1 class="bc-mb-title mb-0">Barriga Cheia</h1>
                        
                        <a href="javascript:void(0)" 
                        class="text-decoration-none fw-bold ms-2" 
                        style="color: #e0c9a6; font-size: 0.85rem; white-space: nowrap;" 
                        data-bs-toggle="modal" 
                        data-bs-target="#modalVerMais">
                            Ver mais
                        </a>
                    </div>
                    <div class="bc-mb-location">
                        <i class="fa-solid fa-location-dot me-1"></i>
                        <span>Olinda-PE · Rua Nilson Sabino Pinho, 222</span>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-start mt-md-2 align-items-end mt-3 mt-md-0 gap-3" style="position: absolute; top: -57px; right: 7px;">
                @* <button type="button" class="btn bc-nav-btn shadow-sm position-relative @(ViewBag.Autenticado ? "btn-acompanhar-pedido" : "btn-acompanhar-pedido-login")">
                    <i class="fa-solid fa-location-dot me-2"></i>
                    <span>
                        Acompanhar pedido
                        @if (ViewBag.Autenticado && ViewBag.TotalPedidos > 0)
                        {
                            <span class="badge rounded-pill shadow bg-danger position-absolute"
                                  style="font-size: 0.7rem; top: -5px; right: -5px;">
                                @ViewBag.TotalPedidos
                                <span class="visually-hidden">pedidos em andamento</span>
                            </span>
                        }
                    </span>
                </button> *@
               
                @if (ViewBag.Autenticado)
                {
                    <div class="dropdown d-inline-block">
                        <button type="button"
                                class="d-flex align-items-center fw-bold shadow-sm btn-lift"
                                id="btn-conta-dropdown-mobile"
                                data-bs-toggle="dropdown" 
                                aria-expanded="false"
                                title="Minha conta"
                                style="color: #4b2c20; border-radius: 50px; padding: 6px 17px; border: 1px solid #eee;">

                            <i class="fa-solid fa-circle-user fs-5 me-2" style="color: #4a2a15;"></i>
                            
                            <span class="text-truncate" style="max-width: 110px; font-size: 0.9rem;font-weight: 600 !important;">
                                @ViewBag.NomeCliente.Split(' ')[0]
                            </span>

                            <i class="fa-solid fa-chevron-down ms-2 seta-menu" style="font-size: 0.7rem; opacity: 0.6;"></i> 
                        </button>

                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-2 mt-2"  id="menu-conta-mobile"
                            style="border-radius: 15px; min-width: 220px; background-color: #ffffff; bottom: 115% !important; top: auto !important; margin-top: 8px;z-index: 99999;">
                            
                            <li class="px-3 py-3">
                                <div class="d-flex flex-column">
                                    <span class="fw-bold" style="font-size: 0.95rem; color: #4b2c20;">Olá, @ViewBag.NomeCliente.Split(' ')[0]!</span>
                                    <small class="text-muted" style="font-size: 0.75rem;">O que deseja fazer agora?</small>
                                </div>
                            </li>

                            <li><hr class="dropdown-divider my-2 opacity-50"></li>

                            @* <li>
                                <button class="dropdown-item py-2 d-flex align-items-center rounded-3" type="button" id="btn-meus-pedidos">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                                        <i class="fa-solid fa-basket-shopping text-secondary" style="font-size: 0.85rem;"></i>
                                    </div>
                                    <span class="fw-semibold">Meus Pedidos</span>
                                </button>
                            </li> *@

                            @* <li>
                                <button class="dropdown-item py-2 d-flex align-items-center rounded-3 btn-acompanhar-pedido btn-acompanhar-pedido-nav btn-hover-sidebar" type="button">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                                        <i class="fas fa-receipt text-secondary" style="font-size: 0.85rem;"></i>
                                    </div>
                                    <span class="fw-semibold">
                                        Meus Pedidos
                                    </span>
                                </button>
                            </li> *@
                            <li>
                                <a href="@Url.Action("Index", "Pedido")"
                                   class="dropdown-item py-2 d-flex align-items-center rounded-3 btn-hover-sidebar text-decoration-none"
                                   style="color: inherit;">

                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3"
                                         style="width: 32px; height: 32px;">
                                        <i class="fas fa-receipt text-secondary" style="font-size: 0.85rem;"></i>
                                    </div>

                                    <span class="fw-semibold">
                                        Meus Pedidos
                                    </span>
                                </a>
                            </li>

                            <li>
                                <button class="dropdown-item py-2 d-flex align-items-center rounded-3 btn-hover-sidebar" type="button" data-bs-toggle="modal" data-bs-target="#modalAlterarSenhaCliente">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                                        <i class="fa-solid fa-lock text-secondary" style="font-size: 0.85rem;"></i>
                                    </div>
                                    <span class="fw-semibold">Alterar Senha</span>
                                </button>
                            </li>

                            <li><hr class="dropdown-divider my-2 opacity-50"></li>

                            <li>
                                <button class="dropdown-item py-2 d-flex align-items-center rounded-3 text-danger" type="button" id="btn-sair">
                                    <div class="bg-danger bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px;">
                                        <i class="fa-solid fa-right-from-bracket" style="font-size: 0.85rem;"></i>
                                    </div>
                                    <span class="fw-semibold">Sair da conta</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                }
                else
                {
                    <button type="button"
                            class="btn btn-light d-md-flex align-items-center fw-bold shadow-sm btn-lift"
                            id="btn-abrir-login"
                            style="color: #4b2c20; border-radius: 50px; padding: 3px 17px; border: 1px solid #eee;"
                            title="Entrar">

                        <i class="fa-solid fa-circle-user fs-5 me-2" style="color: #4a2a15;"></i>
                        <span class="text-truncate" style="max-width: 100px;">Entrar</span>
                    </button>
                }
            </div>
        </div>
    </header>
</section>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function () {
     function abrirModalConta() {
        
        $('#modalAcompanhamentoClienteBody').empty();

        const $body = $('#modalContaClienteBody');
        const modalEl = document.getElementById('modalContaCliente');

        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

        $body.html('<div class="text-muted p-3">Carregando...</div>');

        $.get('/Cliente/ContaClienteModal')
        .done(function (html) {
            $body.html(html);
            modal.show();
        })
        .fail(function () {
            $body.html('<div class="text-danger p-3">Não foi possível carregar seus dados agora.</div>');
            modal.show();
        });
    }

    window.irParaLogin = function() {
        const modalAcompanhamentoEl = document.getElementById('modalAcompanhamentoCliente');
        const instanciaAcompanhamento = bootstrap.Modal.getInstance(modalAcompanhamentoEl);

        if (instanciaAcompanhamento) {
            instanciaAcompanhamento.hide();

            modalAcompanhamentoEl.addEventListener('hidden.bs.modal', function handler() {
                abrirModalConta(); 
                modalAcompanhamentoEl.removeEventListener('hidden.bs.modal', handler);
            }, { once: true });
        } else {
            abrirModalConta();
        }
    };
    
    $(document).on('click', '#btn-abrir-login', abrirModalConta);

    $(document).on('click', '#btn-meus-pedidos', abrirModalConta);

    $(document).on('click', '.btn-acompanhar-pedido-login', abrirModalConta);

    $(document).on('click', '.btn-acompanhar-pedido', function () {

        addLoading("Carregando...");

        setTimeout(() => {
            $.ajax({
                  url: '/Pedido/BuscarModalPedidosEmAndamento',
                method: 'GET',
                success: function (html) {
                    $('#conteudo-modal').empty();
                    $('#conteudo-modal').html(html);

                    const el = document.getElementById('modalPedidosEmAndamento');
                    bootstrap.Modal.getOrCreateInstance(el).show();

                    removeLoading();
                },
                error: function (xhr) {
                    alert(xhr.responseText || 'Erro ao carregar pedidos.');
                    removeLoading();
                }
            });
        }, 800); 
    });


    document.addEventListener('click', async function (e) {
        if (!e.target.closest('#btn-sair')) return;
        addLoading("Saindo...")

        const response = await fetch('/Cliente/Logout', {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (response.ok) {
            window.location.reload();
        }
        else 
        {
            removeLoading();
            alert('Não foi possível sair. Tente novamente.');
        }
    });

    const btn = document.getElementById('btn-conta-dropdown');
    const btnMobile = document.getElementById('btn-conta-dropdown-mobile');

    let dropdownDesktop = btn ? bootstrap.Dropdown.getOrCreateInstance(btn) : null;
    let dropdownMobile = btnMobile ? bootstrap.Dropdown.getOrCreateInstance(btnMobile) : null;

    let aberto = false;
    let abertoMobile = false;

    if (btn) {
        btn.addEventListener('click', function (e) {
            e.stopPropagation();
            if (aberto) dropdownDesktop.hide(); 
            else dropdownDesktop.show();
            
            aberto = !aberto;
            btn.setAttribute('aria-expanded', aberto);
        });
    }

    if (btnMobile) {
        btnMobile.addEventListener('click', function (e) {
            e.stopPropagation();
            // Importante: Usar a instância correta (dropdownMobile)
            if (abertoMobile) dropdownMobile.hide(); 
            else dropdownMobile.show();

            abertoMobile = !abertoMobile;
            btnMobile.setAttribute('aria-expanded', abertoMobile);
        });
    }

    document.addEventListener('click', function (e) {
        if (dropdownDesktop && aberto) {
            dropdownDesktop.hide();
            aberto = false;
        }
        if (dropdownMobile && abertoMobile) {
            dropdownMobile.hide();
            abertoMobile = false;
        }
    });

    document.addEventListener('click', function (e) {
        @* if (!btn.closest('.dropdown')?.contains(e.target)) {
            dropdown.hide();
            aberto = false;
            btn.setAttribute('aria-expanded', 'false');
        } *@
    });

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            dropdown.hide();
            aberto = false;
            btn.setAttribute('aria-expanded', 'false');
        }
    });
  })();
</script>