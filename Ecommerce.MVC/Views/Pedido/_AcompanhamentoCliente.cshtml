@using System.Globalization
@model Ecommerce.MVC.Models.AcompanhamentoPedidosViewModel

@{
    var pt = new CultureInfo("pt-BR");
}

<div class="p-3">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h6 class="fw-bold mb-0">Meus pedidos</h6>
    <button type="button" class="btn btn-sm btn-link text-dark" data-bs-dismiss="modal">Fechar</button>
  </div>

  @if (!Model.Pedidos.Any())
  {
      <div class="alert alert-light border rounded-3 mb-0">
        Você ainda não possui pedidos.
      </div>
  }
  else
  {
      <div class="accordion" id="accPedidos">
        @for (var idx = 0; idx < Model.Pedidos.Count; idx++)
        {
            var p = Model.Pedidos[idx];
            var headId = $"pedHead_{idx}";
            var colId = $"pedCol_{idx}";

            <div class="accordion-item mb-2 border rounded-3">
              <h2 class="accordion-header" id="@headId">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@colId">
                  <div class="w-100 d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-bold">Pedido #@p.PedidoId.ToString().Substring(0, 8)</div>
                      <small class="text-muted">
                        @p.CriadoEmUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                      </small>
                    </div>
                    <div class="text-end">
                      <div class="fw-bold">@p.Total.ToString("C", pt)</div>
                      <small class="text-muted">@p.MetodoEntrega • @p.Pagamento</small>
                    </div>
                  </div>
                </button>
              </h2>

              <div id="@colId" class="accordion-collapse collapse" data-bs-parent="#accPedidos">
                <div class="accordion-body">
                  <div class="mb-2">
                    <div><strong>Entrega:</strong> @(p.MetodoEntrega == "retirar" ? "Retirar na loja" : "Delivery")</div>
                    @if (!string.IsNullOrWhiteSpace(p.EnderecoTexto))
                    {
                      <div class="text-muted small">@p.EnderecoTexto</div>
                    }
                  </div>

                  <div class="bg-white border rounded-3 p-2 mb-2">
                    @foreach (var it in p.Itens)
                    {
                      <div class="d-flex justify-content-between">
                        <div>
                          <div class="fw-bold">@it.Quantidade x @it.ProdutoNome</div>
                          @if (it.Acompanhamentos.Any())
                          {
                            <small class="text-muted d-block">
                              @string.Join(", ", it.Acompanhamentos)
                            </small>
                          }
                        </div>
                        <div class="fw-bold">@it.TotalLinha.ToString("C", pt)</div>
                      </div>
                      <hr class="my-2" />
                    }
                  </div>

                  <div class="d-flex justify-content-between">
                    <span class="text-muted">Subtotal</span>
                    <span>@p.Subtotal.ToString("C", pt)</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="text-muted">Taxa</span>
                    <span>@p.TaxaEntrega.ToString("C", pt)</span>
                  </div>
                  <div class="d-flex justify-content-between fw-bold mt-1">
                    <span>Total</span>
                    <span>@p.Total.ToString("C", pt)</span>
                  </div>
                </div>
              </div>
            </div>
        }
      </div>
  }
</div>
