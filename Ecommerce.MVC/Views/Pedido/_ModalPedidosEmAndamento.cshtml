@using System.Globalization
@using Ecommerce.MVC.Enums
@using Ecommerce.MVC.Models.Pedidos
@model IReadOnlyList<PedidosEmAndamentoViewModel>

@{
    var pt = new CultureInfo("pt-BR");
}

<link rel="stylesheet" href="~/css/pedido/acompanhamento-pedido.css" asp-append-version="true" />

<div class="modal fade" id="modalPedidosEmAndamento" tabindex="-1" aria-labelledby="modalPedidosEmAndamentoLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bc-modal border-0 shadow-lg" style="overflow: hidden;">
            <div class="modal-header border-0 d-flex align-items-center justify-content-between">
                <div class="text-start d-flex align-items-start">
                    <h5 class="modal-title fw-bolder mb-0" style="color: #3c1e0a; font-weight: bold !important; font-size: 1rem; margin-bottom: 0.5rem !important;"><i class="fa-solid fa-fire me-2"></i>Acompanhe seu Pedido</h5>
                    <span class="badge shadow bg-danger"
                          style="font-size: 0.75rem; z-index: 1; margin-left: 7px; margin-top: 3px;">
                        @ViewBag.TotalPedidos
                        <span class="visually-hidden">pedidos em andamento</span>
                    </span>
                </div>
                <button type="button" class="btn-close-custom" title="Fechar" data-bs-dismiss="modal" aria-label="Fechar" style="position: static; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body pt-2 px-2 px-lg-4 bh-pedidos-em-andamento" id="modalPedidosEmAndamentoBody" style="max-height: 87vh; overflow-y: auto;">
                @functions {
                    private string MapStatusBadgeClass(EPedidoStatus status)
                    {
                        return status switch
                        {
                            EPedidoStatus.Cancelado => "bg-danger-subtle text-danger",
                            EPedidoStatus.Concluido => "bg-success-subtle text-success",
                            EPedidoStatus.Pronto => "bg-primary-subtle text-primary",
                            EPedidoStatus.EmPreparo => "bg-warning-subtle text-warning-custom",
                            EPedidoStatus.Confirmado => "bg-info-subtle text-info",
                            EPedidoStatus.AguardandoPagamento => "bg-warning-subtle text-warning-custom",
                            EPedidoStatus.Rascunho => "bg-secondary-subtle text-secondary",
                            _ => "bg-secondary-subtle text-secondary"
                        };
                    }

                    private bool IsRetirada(string metodoEntrega)
                    => (metodoEntrega ?? "").Trim().ToLower() == "retirar";
                }

                <div class="bh-history">
                    <div class="order-list">

                        @if (Model == null || !Model.Any())
                        {
                            <div class="text-center text-muted p-4">
                                Nenhum pedido em andamento no momento.
                            </div>
                        }
                        else
                        {
                            foreach (var p in Model)
                            {
                                var step = p.Step; // vem do VM
                                var badgeClass = MapStatusBadgeClass(p.Status);
                                var metodoRetirada = IsRetirada(p.MetodoEntrega);

                                // precisa de um identificador único pro collapse; use o Código (se for único) ou crie uma propriedade Id no VM
                                var colId = "ped_" + (p.Codigo ?? Guid.NewGuid().ToString("N"));

                                <div class="order-wrapper order-wrapper-hover mb-2" style="border-radius: 16px;">
                                    <div class="order-grid toggle-detalhes" data-target="@colId">
                                        <div>
                                            <span class="label-mobile label-mobile-start">Pedido</span>
                                            <div class="fw-bold label-mobile-start" style="color: #3c1e0abd;">#@p.Codigo</div>
                                        </div>

                                        <div>
                                            <span class="label-mobile label-mobile-end">Data/Hora</span>
                                            <div class="text-muted small label-mobile-end">
                                                @p.CriadoEmUtc.ToLocalTime().ToString("dd/MM HH:mm")
                                            </div>
                                        </div>

                                        <div>
                                            <span class="label-mobile label-mobile-start">Status</span>
                                            <span class="badge @badgeClass py-2 px-3 label-mobile-end rounded-4">@p.StatusTexto</span>
                                        </div>

                                        <div>
                                            <span class="label-mobile label-mobile-end">Total</span>
                                            <div class="fw-bold label-mobile-end" style="color: #3c1e0abd;">@p.Total.ToString("C", pt)</div>
                                        </div>

                                        <div class="col-btn">
                                            <button class="btn-toggle-detalhes" type="button">
                                                <i class="fa-solid fa-chevron-down"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div id="@colId" class="collapse border-top">
                                        <div class="order-stepper">
                                            <div class="step @(step >= 1 ? "done" : "") @(step == 1 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 1)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid fa-clock"></i>
                                                    }
                                                </div>
                                                <span>Pedido</span>
                                            </div>

                                            <div class="step @(step >= 2 ? "done" : "") @(step == 2 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 2)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid fa-receipt"></i>
                                                    }
                                                </div>
                                                <span>Aprovado</span>
                                            </div>

                                            <div class="step @(step >= 3 ? "done" : "") @(step == 3 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 3)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid fa-fire-burner"></i>
                                                    }
                                                </div>
                                                <span>Preparo</span>
                                            </div>

                                            <div class="step @(step >= 4 ? "done" : "") @(step == 4 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 4)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid @(metodoRetirada ? "fa-box-open" : "fa-motorcycle")"></i>
                                                    }
                                                </div>
                                                <span>@(metodoRetirada ? "Pronto" : "Rota")</span>
                                            </div>

                                            <div class="step @(step >= 5 ? "done" : "") @(step == 5 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 5)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid fa-house-chimney-check"></i>
                                                    }
                                                </div>
                                                <span>@(metodoRetirada ? "Retirado" : "Entregue")</span>
                                            </div>
                                        </div>

                                        <div class="bh-pedidos-em-andamento">
                                            <div class="p-4 bg-white shadow-sm order-wrapper">
                                                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                                                    <div class="d-flex align-items-center gap-3">
                                                        <div class="bg-light p-3 rounded-circle text-primary shadow-sm ">
                                                            <i class="fa-solid fa-store fa-lg"></i>
                                                        </div>
                                                        <div>
                                                            <span class="label-mobile">Modo de Entrega</span>
                                                            <div class="fw-bold text-dark">@p.MetodoEntrega</div> @* Alterado para dinâmico *@
                                                            @if (p.HorarioRetirada != default)
                                                            {
                                                                <div class="text-success small fw-semibold">
                                                                    <i class="fa-regular fa-clock me-1"></i>
                                                                    Agendado: @p.HorarioRetirada.ToLocalTime().ToString("dd/MM/yyyy HH:mm", pt)
                                                                </div>
                                                            }
                                                            else
                                                            {
                                                                <div class="text-muted small">Aguardando definição de horário</div>
                                                            }
                                                        </div>
                                                    </div>

                                                    <div class="text-md-center bg-light p-2 px-3 rounded-2 shadow-sm">
                                                        <span class="label-mobile d-block">Status de Pagamento</span>

                                                        <span class="badge rounded-pill px-3 @(p.StatusPagamento == "Sinal Pago" ? "bg-success" : "bg-warning text-dark")">
                                                            @p.StatusPagamento
                                                        </span>
                                                    </div>
                                                </div>

                                                <hr class="opacity-10 my-3" />

                                                <div class="bg-light p-3 rounded-4 border-dashed mb-4 shadow-sm">
                                                    <div class="row align-items-center">
                                                        <div class="col-md-7">
                                                            <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Sinal para Produção (50%)</small>
                                                            <div class="fs-4 fw-bold lh-1 text-success">
                                                                @p.ValorSinal.ToString("C", pt)
                                                            </div>
                                                            <small class="text-muted" style="font-size: 0.75rem;">
                                                                @* Note: Alterado para ValorRestanteRetirada conforme calculamos no C# *@
                                                                Restante na retirada: <b>@p.ValorRestanteRetirada.ToString("C", pt)</b>
                                                            </small>
                                                        </div>
                                                        <div class="col-md-5 text-md-end mt-2 mt-md-0">
                                                            <small class="text-muted d-block" style="font-size: 0.7rem;">Total do pedido</small>
                                                            <span class="fw-bold text-dark fs-5">
                                                                @p.Total.ToString("C", pt)
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="progress mt-3" style="height: 6px; background-color: #e9ecef;">
                                                        @* Se estiver pago, a barra fica 100% *@
                                                        <div class="progress-bar bg-success" role="progressbar" style="width: @(p.StatusPagamento == "Sinal Pago" ? "100%" : "50%")"></div>
                                                    </div>
                                                </div>

                                                @if (p.StatusPagamento != "Sinal Pago")
                                                {
                                                    <div class="row g-3 mb-4">
                                                        <div class="col-12 col-lg-5">
                                                            <div class="bg-white p-3 rounded-4 shadow-sm h-100 text-center">
                                                                <div class="fw-bold mb-2" style="color: var(--bh-primary); font-size:0.9rem;">Escaneie o QR Code</div>
                                                                <img src="@p.PixQrCodeUrl" alt="QR Code PIX" class="img-fluid rounded-3 border p-2 mb-2" style="max-width: 160px;" />
                                                                <div class="badge rounded-pill text-bg-light border d-block w-100 py-2">
                                                                    <i class="fa-regular fa-clock me-1"></i> Expira em @p.PixExpiraEm
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-12 col-lg-7">
                                                            <div class="bg-white p-3 rounded-4 shadow-sm h-100 d-flex flex-column">
                                                                <label class="small text-muted fw-bold text-uppercase mb-2" style="font-size: 0.65rem;">PIX Copia e Cola</label>

                                                                <div class="input-group mb-3">
                                                                    <textarea id="pixCopiaCola_@p.Codigo" class="form-control form-control-sm bg-light" readonly style="resize: none; font-size: 0.75rem;">@p.PixCopiaCola</textarea>
                                                                    <button class="btn btn-outline-dark d-flex flex-column align-items-center justify-content-center px-3" onclick="copyToClipboard('pixCopiaCola_@p.Codigo')">
                                                                        <i class="fa-regular fa-copy mb-1"></i>
                                                                        <span style="font-size: 0.7rem; font-weight: bold;">Copiar</span>
                                                                    </button>
                                                                </div>

                                                                <div class="bg-light p-3 rounded-3 mb-3" style="font-size: 0.85rem; border: 1px dashed #dee2e6;">
                                                                    <div class="d-flex justify-content-between mb-1">
                                                                        <span class="text-muted">Identificador</span>
                                                                        <span class="fw-bold text-dark text-truncate ms-2">@p.PixIdentificador</span>
                                                                    </div>
                                                                    <div class="d-flex justify-content-between mb-1">
                                                                        <span class="text-muted">Beneficiário</span>
                                                                        <span class="fw-bold text-dark">@p.PixBeneficiario</span>
                                                                    </div>
                                                                    <div class="d-flex justify-content-between">
                                                                        <span class="text-muted">Valor</span>
                                                                        <span class="fw-bold text-dark">@p.ValorSinal.ToString("C", pt)</span>
                                                                    </div>
                                                                </div>

                                                                <button class="btn btn-success w-100 py-2 fw-bold rounded-3 shadow-sm mt-auto">
                                                                    <i class="fa-solid fa-circle-check me-2"></i>Já paguei
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }

                                                <div class="card border shadow-sm rounded-4 mb-3" style="background: #a9a9a936;">
                                                    <div class="card-body p-4">
                                                        @if (p.Itens == null || !p.Itens.Any())
                                                        {
                                                            <div class="text-center py-3 text-muted small">Nenhum item encontrado.</div>
                                                        }
                                                        else
                                                        {
                                                            @foreach (var it in p.Itens)
                                                            {
                                                                <div class="mb-1">
                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                        <span class="fw-bold text-dark" style="font-size: 0.85rem;">
                                                                            @it.Quantidade x @it.ProdutoNome
                                                                        </span>
                                                                        <span class="fw-bold text-dark" style="font-size: 0.85rem;">
                                                                            @it.TotalLinha.ToString("C", pt)
                                                                        </span>
                                                                    </div>

                                                                    @if (it.Acompanhamentos?.Any() == true)
                                                                    {
                                                                        <div class="mt-1">
                                                                            @foreach (var ac in it.Acompanhamentos)
                                                                            {
                                                                                <div class="d-flex justify-content-between text-muted ms-2" style="font-size: 0.75rem;">
                                                                                    <span>+ @ac.Nome.ToLower()</span>
                                                                                    <span>@ac.Preco.ToString("C", pt)</span>
                                                                                </div>
                                                                            }
                                                                        </div>
                                                                    }
                                                                </div>
                                                            }

                                                            <hr class="text-muted opacity-25">
                                                            <div class="d-flex justify-content-between align-items-center mt-3">
                                                                <span class="text-secondary" style="font-size: 1rem;">Total da encomenda</span>
                                                                <span class="fw-bold text-dark" style="font-size: 1.1rem;">
                                                                    @p.Total.ToString("C", pt)
                                                                </span>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>

                                                @* Observações *@
                                                <div class="mb-2">
                                                    <span class="label-mobile">Observações</span>
                                                    <div class="small italic text-muted">
                                                        <i class="fa-regular fa-comment-dots me-1 opacity-50"></i>
                                                        @(string.IsNullOrWhiteSpace(p.Observacao) ? "Nenhuma observação" : p.Observacao)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/js/pedido/acompanhamento-pedido.js" asp-append-version="true"></script>
