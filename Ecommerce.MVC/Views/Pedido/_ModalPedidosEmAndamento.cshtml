@using System.Globalization
@using Ecommerce.MVC.Enums
@using Ecommerce.MVC.Models.Pedidos
@model IReadOnlyList<PedidosEmAndamentoViewModel>

@{
    var pt = new CultureInfo("pt-BR");
}

<link rel="stylesheet" href="~/css/pedido/acompanhamento-pedido.css" asp-append-version="true" />

<div class="modal fade" id="modalPedidosEmAndamento" tabindex="-1" aria-labelledby="modalPedidosEmAndamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bc-modal border-0 shadow-lg" style="overflow: hidden;">
            <div class="modal-header border-0 d-flex align-items-center justify-content-between">
                <div class="text-start">
                    <h5 class="modal-title fw-bolder mb-0" style="color: #3c1e0a; font-weight: bold !important; font-size: 1rem; margin-bottom: 0.5rem !important;"><i class="fa-solid fa-fire me-2"></i>Acompanhe seu Pedido</h5>
                </div>
                <button type="button" class="btn-close-custom" title="Fechar" data-bs-dismiss="modal" aria-label="Fechar" style="position: static; font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body pt-2 px-4 bh-pedidos-em-andamento" id="modalPedidosEmAndamentoBody">
                @functions {
                    private string MapStatusBadgeClass(EPedidoStatus status)
                    {
                        return status switch
                        {
                            EPedidoStatus.Cancelado => "bg-danger-subtle text-danger",
                            EPedidoStatus.Concluido => "bg-success-subtle text-success",
                            EPedidoStatus.Pronto => "bg-primary-subtle text-primary",
                            EPedidoStatus.EmPreparo => "bg-warning-subtle text-warning",
                            EPedidoStatus.Confirmado => "bg-info-subtle text-info",
                            EPedidoStatus.AguardandoPagamento => "bg-warning-subtle text-warning",
                            EPedidoStatus.Rascunho => "bg-secondary-subtle text-secondary",
                            _ => "bg-secondary-subtle text-secondary"
                        };
                    }

                    private bool IsRetirada(string metodoEntrega)
                    => (metodoEntrega ?? "").Trim().ToLower() == "retirar";
                }

                <div class="bh-history">
                    <div class="order-list">

                        @if (Model == null || !Model.Any())
                        {
                            <div class="text-center text-muted p-4">
                                Nenhum pedido em andamento no momento.
                            </div>
                        }
                        else
                        {
                            foreach (var p in Model)
                            {
                                var step = p.Step; // vem do VM
                                var badgeClass = MapStatusBadgeClass(p.Status);
                                var metodoRetirada = IsRetirada(p.MetodoEntrega);

                                // precisa de um identificador único pro collapse; use o Código (se for único) ou crie uma propriedade Id no VM
                                var colId = "ped_" + (p.Codigo ?? Guid.NewGuid().ToString("N"));

                                <div class="order-wrapper">
                                    <div class="order-grid toggle-detalhes" data-target="@colId">
                                        <div style="text-align: start;">
                                            <span class="label-mobile label-mobile-start">Pedido</span>
                                            <div class="fw-bold" style="color:var(--bh-primary)">#@p.Codigo</div>
                                        </div>

                                        <div style="text-align: end;">
                                            <span class="label-mobile label-mobile-end">Data/Hora</span>
                                            <div class="text-muted small">
                                                @p.CriadoEmUtc.ToLocalTime().ToString("dd/MM HH:mm")
                                            </div>
                                        </div>

                                        <div style="text-align: start;">
                                            <span class="label-mobile label-mobile-start">Status</span>
                                            <span class="badge @badgeClass px-3">@p.StatusTexto</span>
                                        </div>

                                        <div style="text-align: end;">
                                            <span class="label-mobile label-mobile-end">Total</span>
                                            <div class="fw-bold">@p.Total.ToString("C", pt)</div>
                                        </div>

                                        <div class="col-btn">
                                            <button class="btn-toggle-detalhes" type="button">
                                                <i class="fa-solid fa-chevron-down"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div id="@colId" class="collapse border-top">
                                        <div class="order-stepper">
                                            <div class="step @(step >= 1 ? "done" : "") @(step == 1 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 1)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid fa-clock"></i>
                                                    }
                                                </div>
                                                <span>Pedido</span>
                                            </div>

                                            <div class="step @(step >= 2 ? "done" : "") @(step == 2 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 2)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid fa-receipt"></i>
                                                    }
                                                </div>
                                                <span>Aprovado</span>
                                            </div>

                                            <div class="step @(step >= 3 ? "done" : "") @(step == 3 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 3)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid fa-fire-burner"></i>
                                                    }
                                                </div>
                                                <span>Preparo</span>
                                            </div>

                                            <div class="step @(step >= 4 ? "done" : "") @(step == 4 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 4)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid @(metodoRetirada ? "fa-box-open" : "fa-motorcycle")"></i>
                                                    }
                                                </div>
                                                <span>@(metodoRetirada ? "Pronto" : "Rota")</span>
                                            </div>

                                            <div class="step @(step >= 5 ? "done" : "") @(step == 5 ? "active" : "")">
                                                <div class="step-circle">
                                                    @if (step > 5)
                                                    {
                                                        <i class="fa-solid fa-check"></i>
                                                    }
                                                    else
                                                    {

                                                        <i class="fa-solid fa-house-chimney-check"></i>
                                                    }
                                                </div>
                                                <span>@(metodoRetirada ? "Retirado" : "Entregue")</span>
                                            </div>
                                        </div>

                                        <div class="p-4 bg-light">
                                            <div class="row g-3">
                                                <div class="col-12">
                                                    <div class="p-3 bg-white rounded border shadow-sm">
                                                        <small class="text-muted d-block mb-1">
                                                            @(metodoRetirada ? "Retirada" : "Entrega"):
                                                        </small>
                                                        <p class="small fw-bold mb-0">
                                                            @(metodoRetirada ? "Retirada na unidade" : "Endereço de entrega não informado")
                                                        </p>

                                                        <div class="mt-3 text-muted small">
                                                            Detalhes dos itens serão exibidos aqui (carregamento sob demanda recomendado).
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/js/pedido/acompanhamento-pedido.js" asp-append-version="true"></script>
